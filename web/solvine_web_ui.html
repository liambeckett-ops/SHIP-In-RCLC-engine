<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solvine Agent Collective</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .status-bar {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .status-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            text-align: center;
            padding: 10px;
        }

        .status-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .status-item .label {
            font-size: 0.9rem;
            color: #666;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            flex: 1;
        }

        .sidebar {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            height: fit-content;
        }

        .sidebar.right {
            max-height: 600px;
            overflow-y: auto;
        }

        .chat-area {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .agent-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .agent-card.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scale(1.05);
            border: 2px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .agent-load-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: rgba(255, 215, 0, 0.8);
            transition: width 0.3s ease;
            border-radius: 0 0 10px 10px;
        }

        .agent-load-text {
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 3px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .agent-card .name {
            font-weight: bold;
            font-size: 1rem;
        }

        .agent-card .role {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .agent-card .stability {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 15px 15px 0 0;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.agent {
            background: white;
            border: 1px solid #e0e0e0;
            margin-right: auto;
        }

        .message.agent .header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            color: #333;
        }

        .message.agent .agent-name {
            font-weight: bold;
            color: #667eea;
        }

        .message.agent .role {
            color: #666;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .message.agent .stability {
            margin-left: auto;
            font-size: 0.8rem;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-radius: 0 0 15px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .send-button:hover {
            transform: scale(1.1);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .quick-actions {
            margin-top: 20px;
        }

        .quick-actions h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .quick-button {
            display: block;
            width: 100%;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .quick-button:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .agents-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        /* NEW FEATURES CSS */
        .session-log {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .session-log h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-entry {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
        }

        .log-timestamp {
            font-size: 0.8em;
            color: #666;
            font-weight: bold;
        }

        .log-agent {
            font-weight: bold;
            color: #667eea;
        }

        .log-message {
            margin-top: 5px;
            line-height: 1.4;
        }

        .agent-creator {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .agent-creator h3 {
            margin: 0 0 15px 0;
            color: #f5576c;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .create-agent-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }

        .create-agent-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
        }

        .override-panel {
            background: rgba(255, 99, 71, 0.1);
            border: 2px solid #ff6347;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .override-panel h3 {
            margin: 0 0 15px 0;
            color: #ff6347;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .emergency-btn {
            background: linear-gradient(135deg, #ff6347 0%, #ff4500 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .emergency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 99, 71, 0.4);
        }

        .keyboard-shortcuts {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .keyboard-shortcuts h4 {
            margin: 0 0 10px 0;
            color: #667eea;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .shortcut-key {
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .agent-rotator {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .agent-rotator h4 {
            margin: 0 0 15px 0;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rotation-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .rotation-btn {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .rotation-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(132, 250, 176, 0.4);
        }

        .rotation-status {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
        }

        /* Model Switcher Styles */
        .model-switcher {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .model-switcher h4 {
            margin: 0 0 15px 0;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-status {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .status-indicator {
            font-size: 1.2rem;
        }

        .model-benefits {
            margin-top: 15px;
        }

        .model-benefits h5 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 0.9rem;
        }

        .model-benefits ul {
            margin: 0;
            padding-left: 20px;
            font-size: 0.8rem;
            color: #666;
        }

        .model-benefits li {
            margin: 5px 0;
        }

        .setup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .setup-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Solvine Agent Collective</h1>
            <p>Your Personal AI Assistant Network</p>
        </div>

        <div class="status-bar">
            <div class="status-items">
                <div class="status-item">
                    <div class="value" id="agent-count">6</div>
                    <div class="label">Active Agents</div>
                </div>
                <div class="status-item">
                    <div class="value" id="system-stability">0.85</div>
                    <div class="label">System Stability</div>
                </div>
                <div class="status-item">
                    <div class="value" id="session-messages">0</div>
                    <div class="label">Session Messages</div>
                </div>
                <div class="status-item">
                    <div class="value" id="uptime">Starting...</div>
                    <div class="label">Uptime</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h3>🎯 Select Agent</h3>
                <div class="agents-grid" id="agents-grid">
                    <!-- Agents will be loaded here -->
                </div>

                <div class="quick-actions">
                    <h3>⚡ Quick Actions</h3>
                    <button class="quick-button" onclick="sendQuickMessage('Hello! How are all the agents doing?')">
                        👋 General Greeting
                    </button>
                    <button class="quick-button" onclick="sendQuickMessage('What financial advice do you have for me?')">
                        💰 Ask Midas About Finances
                    </button>
                    <button class="quick-button" onclick="sendQuickMessage('I need help with something urgent')">
                        🚨 Emergency Support
                    </button>
                    <button class="quick-button" onclick="sendQuickMessage('@jasper Show me the system status')">
                        📊 System Status
                    </button>
                    <button class="quick-button" onclick="sendQuickMessage('Help me understand something complex')">
                        🧠 Deep Analysis
                    </button>
                </div>
            </div>

            <div class="chat-area">
                <div class="chat-messages" id="chat-messages">
                    <div class="message agent">
                        <div class="header">
                            <span class="agent-name">🎯 Jasper</span>
                            <span class="role">Head Agent & Coordinator</span>
                            <span class="stability">🟢 Stable</span>
                        </div>
                        <div>Welcome to the Solvine Agent Collective! I'm Jasper, your head coordinator. The team and I are ready to assist you with anything you need. Feel free to ask questions, and we'll route them to the most appropriate agent.</div>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>Agents are thinking...</div>
                </div>

                <div class="chat-input-area">
                    <div class="input-row">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Type your message here..." />
                        <button id="send-button" class="send-button" onclick="sendMessage()">🚀</button>
                    </div>
                </div>
            </div>

            <!-- NEW RIGHT SIDEBAR WITH ALL FEATURES -->
            <div class="sidebar right">
                <!-- SESSION LOG PANEL -->
                <div class="session-log">
                    <h3>📜 Session Log</h3>
                    <div id="session-log-entries">
                        <!-- Log entries will be populated here -->
                    </div>
                </div>

                <!-- AGENT ROTATOR/ORGANIZER -->
                <div class="agent-rotator">
                    <h4>🔄 Agent Rotator</h4>
                    <div class="rotation-controls">
                        <button class="rotation-btn" onclick="startAutoRotation()">▶️ Auto</button>
                        <button class="rotation-btn" onclick="stopAutoRotation()">⏸️ Stop</button>
                        <button class="rotation-btn" onclick="nextAgent()">➡️ Next</button>
                    </div>
                    <div class="rotation-status" id="rotation-status">
                        Auto rotation: OFF | Current: Manual Selection
                    </div>
                </div>

                <!-- AGENT CREATOR -->
                <div class="agent-creator">
                    <h3>🤖 Create New Agent</h3>
                    <div class="form-group">
                        <label for="agent-name">Agent Name:</label>
                        <input type="text" id="agent-name" placeholder="e.g., DataAnalyst">
                    </div>
                    <div class="form-group">
                        <label for="agent-role">Role/Specialty:</label>
                        <input type="text" id="agent-role" placeholder="e.g., Data Analysis & Insights">
                    </div>
                    <div class="form-group">
                        <label for="agent-personality">Personality:</label>
                        <select id="agent-personality">
                            <option value="analytical">Analytical & Logical</option>
                            <option value="creative">Creative & Innovative</option>
                            <option value="supportive">Supportive & Encouraging</option>
                            <option value="direct">Direct & Efficient</option>
                            <option value="playful">Playful & Engaging</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="agent-skills">Skills & Capabilities:</label>
                        <textarea id="agent-skills" rows="3" placeholder="e.g., Python, Statistics, Data Visualization, Machine Learning"></textarea>
                    </div>
                    <button class="create-agent-btn" onclick="createNewAgent()">
                        ✨ Create Agent
                    </button>
                </div>

                <!-- OVERRIDE/EMERGENCY PANEL -->
                <div class="override-panel">
                    <h3>⚠️ Emergency Override</h3>
                    <button class="emergency-btn" onclick="emergencyContradictionScan()">
                        🔍 Contradiction Scan
                    </button>
                    <button class="emergency-btn" onclick="forceAgentReset()">
                        🔄 Force Agent Reset
                    </button>
                    <button class="emergency-btn" onclick="systemDiagnostic()">
                        🩺 System Diagnostic
                    </button>
                    <button class="emergency-btn" onclick="emergencyShutdown()">
                        🛑 Emergency Stop
                    </button>
                </div>

                <!-- KEYBOARD SHORTCUTS -->
                <div class="keyboard-shortcuts">
                    <h4>⌨️ Keyboard Shortcuts</h4>
                    <div class="shortcut-item">
                        <span>Send Message</span>
                        <span class="shortcut-key">Enter</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Next Agent</span>
                        <span class="shortcut-key">Ctrl+→</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Previous Agent</span>
                        <span class="shortcut-key">Ctrl+←</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Clear Chat</span>
                        <span class="shortcut-key">Ctrl+L</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Emergency Override</span>
                        <span class="shortcut-key">Ctrl+E</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Auto-Rotate</span>
                        <span class="shortcut-key">Ctrl+R</span>
                    </div>
                </div>

                <!-- NEW: MODEL SWITCHER PANEL -->
                <div class="model-switcher">
                    <h4>⚙️ Model Switcher</h4>
                    <div class="form-group">
                        <label for="model-provider">Provider:</label>
                        <select id="model-provider" onchange="switchModelProvider()">
                            <option value="ollama" selected>Ollama (Current)</option>
                            <option value="openai_local">OpenAI Local (Free!)</option>
                        </select>
                    </div>
                    <div class="model-status" id="model-status">
                        <div class="status-row">
                            <span>Current: Ollama</span>
                            <span class="status-indicator">🟢</span>
                        </div>
                        <div class="status-row">
                            <span>Cost: Free</span>
                            <span>Privacy: 🔒 Local</span>
                        </div>
                    </div>
                    <div class="model-benefits">
                        <h5>🚀 OpenAI Local Benefits:</h5>
                        <ul>
                            <li>⚡ Faster responses</li>
                            <li>🎯 Better reasoning</li>
                            <li>💡 Enhanced creativity</li>
                            <li>🔒 Still 100% private</li>
                            <li>💰 Still completely free</li>
                        </ul>
                        <button class="setup-btn" onclick="showSetupGuide()">
                            📋 Setup Guide
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedAgent = null;
        let sessionMessageCount = 0;

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            loadAgents();
            loadSystemStatus();
            
            // Set up enter key for sending messages
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Update uptime every minute
            setInterval(updateUptime, 60000);
        });

        async function loadAgents() {
            try {
                const response = await fetch('/agents');
                const data = await response.json();
                
                const agentsGrid = document.getElementById('agents-grid');
                agentsGrid.innerHTML = '';

                // Add "Auto-Select" option
                const autoCard = document.createElement('div');
                autoCard.className = 'agent-card active';
                autoCard.onclick = () => selectAgent(null, autoCard);
                autoCard.innerHTML = `
                    <div class="name">🎯 Auto</div>
                    <div class="role">Smart Selection</div>
                    <div class="stability">🤖 AI Powered</div>
                `;
                agentsGrid.appendChild(autoCard);

                // Handle both array and object responses
                const agents = data.agents || data;
                if (Array.isArray(agents)) {
                    agents.forEach(agent => {
                        const card = document.createElement('div');
                        card.className = 'agent-card';
                        card.onclick = () => selectAgent(agent.name, card);
                        
                        const emoji = getAgentEmoji(agent.name);
                        const stabilityIcon = agent.stability > 0.7 ? '🟢' : agent.stability > 0.4 ? '🟡' : '🔴';
                        
                        card.innerHTML = `
                            <div class="name">${emoji} ${agent.name.charAt(0).toUpperCase() + agent.name.slice(1)}</div>
                            <div class="role">${agent.role}</div>
                            <div class="stability">${stabilityIcon} ${(agent.stability * 100).toFixed(0)}%</div>
                        `;
                        
                        agentsGrid.appendChild(card);
                    });
                }
                
                // Update agent count
                const totalAgents = Array.isArray(agents) ? agents.length : 0;
                document.getElementById('agent-count').textContent = totalAgents + 1; // +1 for auto-select
                
            } catch (error) {
                console.error('Failed to load agents:', error);
                // Add fallback agents if API fails
                addFallbackAgents();
            }
        }
        
        function addFallbackAgents() {
            const agentsGrid = document.getElementById('agents-grid');
            const fallbackAgents = [
                { name: 'jasper', role: 'Head Agent & Coordinator', stability: 0.85 },
                { name: 'midas', role: 'Financial Advisor', stability: 0.87 },
                { name: 'aiven', role: 'Creative Analyst', stability: 0.91 },
                { name: 'halcyon', role: 'Crisis Support', stability: 0.94 },
                { name: 'veilsynth', role: 'Myth Guardian', stability: 0.82 },
                { name: 'quanta', role: 'Computational', stability: 0.89 }
            ];
            
            fallbackAgents.forEach(agent => {
                const card = document.createElement('div');
                card.className = 'agent-card';
                card.onclick = () => selectAgent(agent.name, card);
                
                const emoji = getAgentEmoji(agent.name);
                const stabilityIcon = agent.stability > 0.7 ? '🟢' : agent.stability > 0.4 ? '🟡' : '🔴';
                
                card.innerHTML = `
                    <div class="name">${emoji} ${agent.name.charAt(0).toUpperCase() + agent.name.slice(1)}</div>
                    <div class="role">${agent.role}</div>
                    <div class="stability">${stabilityIcon} ${(agent.stability * 100).toFixed(0)}%</div>
                `;
                
                agentsGrid.appendChild(card);
            });
        }

        async function loadSystemStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                document.getElementById('agent-count').textContent = data.agents_count || 6;
                document.getElementById('system-stability').textContent = (data.system_stability || 0.85).toFixed(2);
                document.getElementById('uptime').textContent = data.uptime || 'Starting...';
            } catch (error) {
                console.error('Failed to load system status:', error);
                // Set fallback values
                document.getElementById('agent-count').textContent = '6';
                document.getElementById('system-stability').textContent = '0.85';
                document.getElementById('uptime').textContent = 'Unknown';
            }
        }

        function selectAgent(agentName, cardElement) {
            // Remove active class from all cards
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Add active class to selected card
            cardElement.classList.add('active');
            
            selectedAgent = agentName;
        }

        function getAgentEmoji(agentName) {
            const emojis = {
                'jasper': '🎯',
                'midas': '💰',
                'aiven': '🎨',
                'halcyon': '🛡️',
                'veilsynth': '👁️',
                'quanta': '🧮'
            };
            return emojis[agentName] || '🤖';
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Clear input and disable send button
            input.value = '';
            document.getElementById('send-button').disabled = true;
            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        agent: selectedAgent
                    })
                });
                
                const agents = await response.json();
                
                // Add agent responses to chat
                agents.forEach(agent => {
                    addAgentMessageToChat(agent);
                });
                
                sessionMessageCount += agents.length + 1;
                document.getElementById('session-messages').textContent = sessionMessageCount;
                
            } catch (error) {
                console.error('Failed to send message:', error);
                addMessageToChat('system', 'Sorry, there was an error sending your message. Please try again.');
            } finally {
                document.getElementById('send-button').disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        }

        function sendQuickMessage(message) {
            document.getElementById('chat-input').value = message;
            sendMessage();
        }

        function addMessageToChat(type, message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addAgentMessageToChat(agent) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent';
            
            const emoji = getAgentEmoji(agent.agent);
            const stabilityIcon = agent.stability_score > 0.7 ? '🟢' : agent.stability_score > 0.4 ? '🟡' : '🔴';
            const primaryIndicator = agent.is_primary ? '🎯' : '💭';
            
            messageDiv.innerHTML = `
                <div class="header">
                    <span class="agent-name">${primaryIndicator} ${emoji} ${agent.agent.charAt(0).toUpperCase() + agent.agent.slice(1)}</span>
                    <span class="role">${agent.role}</span>
                    <span class="stability">${stabilityIcon} ${(agent.stability_score * 100).toFixed(0)}%</span>
                </div>
                <div>${agent.message}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateUptime() {
            loadSystemStatus();
        }

        // NEW FEATURE IMPLEMENTATIONS

        // Session Log Variables
        let sessionLog = [];
        let agentLoadStats = {};
        let autoRotationActive = false;
        let rotationInterval = null;
        let currentAgentIndex = 0;
        let availableAgents = [];

        // Initialize new features
        document.addEventListener('DOMContentLoaded', function() {
            // Existing initialization...
            loadAgents();
            loadSystemStatus();
            
            // Set up enter key for sending messages
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // NEW: Set up keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey) {
                    switch(e.key) {
                        case 'ArrowRight':
                            e.preventDefault();
                            nextAgent();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            previousAgent();
                            break;
                        case 'l':
                            e.preventDefault();
                            clearChat();
                            break;
                        case 'e':
                            e.preventDefault();
                            emergencyContradictionScan();
                            break;
                        case 'r':
                            e.preventDefault();
                            toggleAutoRotation();
                            break;
                    }
                }
            });

            // Update uptime every minute
            setInterval(updateUptime, 60000);
            
            // Initialize session log with welcome message
            addToSessionLog('System', 'Session started - Welcome to Solvine!');
        });

        // SESSION LOG FUNCTIONS
        function addToSessionLog(agentName, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp: timestamp,
                agent: agentName,
                message: message.substring(0, 100) + (message.length > 100 ? '...' : '')
            };
            
            sessionLog.push(logEntry);
            updateSessionLogDisplay();
            
            // Update agent load statistics
            if (!agentLoadStats[agentName]) {
                agentLoadStats[agentName] = 0;
            }
            agentLoadStats[agentName]++;
            updateAgentLoadBars();
        }

        function updateSessionLogDisplay() {
            const logContainer = document.getElementById('session-log-entries');
            const recentEntries = sessionLog.slice(-10); // Show last 10 entries
            
            logContainer.innerHTML = recentEntries.map(entry => `
                <div class="log-entry">
                    <div class="log-timestamp">${entry.timestamp}</div>
                    <div class="log-agent">${entry.agent}</div>
                    <div class="log-message">${entry.message}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateAgentLoadBars() {
            const agentCards = document.querySelectorAll('.agent-card');
            const maxLoad = Math.max(...Object.values(agentLoadStats));
            
            agentCards.forEach(card => {
                const agentName = card.querySelector('.name').textContent.split(' ').pop().toLowerCase();
                const loadCount = agentLoadStats[agentName] || 0;
                const loadPercentage = maxLoad > 0 ? (loadCount / maxLoad) * 100 : 0;
                
                // Create or update load bar
                let loadBar = card.querySelector('.agent-load-bar');
                if (!loadBar) {
                    loadBar = document.createElement('div');
                    loadBar.className = 'agent-load-bar';
                    card.appendChild(loadBar);
                }
                loadBar.style.width = loadPercentage + '%';
                
                // Add load text
                let loadText = card.querySelector('.agent-load-text');
                if (!loadText) {
                    loadText = document.createElement('div');
                    loadText.className = 'agent-load-text';
                    card.appendChild(loadText);
                }
                loadText.textContent = `${loadCount} messages`;
            });
        }

        // AGENT ROTATION FUNCTIONS
        function startAutoRotation() {
            if (autoRotationActive) return;
            
            autoRotationActive = true;
            updateRotationStatus();
            
            // Rotate every 30 seconds
            rotationInterval = setInterval(() => {
                nextAgent();
            }, 30000);
            
            addToSessionLog('System', 'Auto-rotation started (30s intervals)');
        }

        function stopAutoRotation() {
            autoRotationActive = false;
            if (rotationInterval) {
                clearInterval(rotationInterval);
                rotationInterval = null;
            }
            updateRotationStatus();
            addToSessionLog('System', 'Auto-rotation stopped');
        }

        function toggleAutoRotation() {
            if (autoRotationActive) {
                stopAutoRotation();
            } else {
                startAutoRotation();
            }
        }

        function nextAgent() {
            const agentCards = document.querySelectorAll('.agent-card');
            if (agentCards.length === 0) return;
            
            currentAgentIndex = (currentAgentIndex + 1) % agentCards.length;
            agentCards[currentAgentIndex].click();
            
            const agentName = agentCards[currentAgentIndex].querySelector('.name').textContent;
            addToSessionLog('System', `Rotated to agent: ${agentName}`);
        }

        function previousAgent() {
            const agentCards = document.querySelectorAll('.agent-card');
            if (agentCards.length === 0) return;
            
            currentAgentIndex = (currentAgentIndex - 1 + agentCards.length) % agentCards.length;
            agentCards[currentAgentIndex].click();
            
            const agentName = agentCards[currentAgentIndex].querySelector('.name').textContent;
            addToSessionLog('System', `Rotated to agent: ${agentName}`);
        }

        function updateRotationStatus() {
            const statusDiv = document.getElementById('rotation-status');
            const currentAgent = selectedAgent || 'Auto-Select';
            statusDiv.textContent = `Auto rotation: ${autoRotationActive ? 'ON' : 'OFF'} | Current: ${currentAgent}`;
        }

        // AGENT CREATOR FUNCTIONS
        async function createNewAgent() {
            const name = document.getElementById('agent-name').value.trim();
            const role = document.getElementById('agent-role').value.trim();
            const personality = document.getElementById('agent-personality').value;
            const skills = document.getElementById('agent-skills').value.trim();
            
            if (!name || !role) {
                alert('Please fill in at least the name and role fields.');
                return;
            }
            
            const agentData = {
                name: name,
                role: role,
                personality: personality,
                skills: skills.split(',').map(s => s.trim()),
                stability: 0.8 // Start with good stability
            };
            
            try {
                const response = await fetch('/create_agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(agentData)
                });
                
                if (response.ok) {
                    alert(`✅ Agent "${name}" created successfully!`);
                    
                    // Clear form
                    document.getElementById('agent-name').value = '';
                    document.getElementById('agent-role').value = '';
                    document.getElementById('agent-skills').value = '';
                    
                    // Reload agents
                    loadAgents();
                    addToSessionLog('System', `New agent created: ${name}`);
                } else {
                    const error = await response.text();
                    alert(`❌ Failed to create agent: ${error}`);
                }
            } catch (error) {
                alert(`❌ Error creating agent: ${error.message}`);
            }
        }

        // EMERGENCY OVERRIDE FUNCTIONS
        async function emergencyContradictionScan() {
            addToSessionLog('System', '🔍 Emergency contradiction scan initiated');
            
            try {
                const response = await fetch('/emergency/contradiction_scan', {
                    method: 'POST'
                });
                
                const result = await response.json();
                alert(`🔍 Contradiction Scan Results:\n${result.message}`);
                addToSessionLog('System', 'Contradiction scan completed');
            } catch (error) {
                alert(`❌ Scan failed: ${error.message}`);
            }
        }

        async function forceAgentReset() {
            if (!confirm('⚠️ This will reset all agent states. Continue?')) return;
            
            addToSessionLog('System', '🔄 Force agent reset initiated');
            
            try {
                const response = await fetch('/emergency/reset_agents', {
                    method: 'POST'
                });
                
                const result = await response.json();
                alert(`🔄 Agent Reset: ${result.message}`);
                loadAgents();
                addToSessionLog('System', 'Agent reset completed');
            } catch (error) {
                alert(`❌ Reset failed: ${error.message}`);
            }
        }

        async function systemDiagnostic() {
            addToSessionLog('System', '🩺 System diagnostic initiated');
            
            try {
                const response = await fetch('/emergency/diagnostic', {
                    method: 'POST'
                });
                
                const result = await response.json();
                alert(`🩺 System Diagnostic:\n${JSON.stringify(result, null, 2)}`);
                addToSessionLog('System', 'System diagnostic completed');
            } catch (error) {
                alert(`❌ Diagnostic failed: ${error.message}`);
            }
        }

        async function emergencyShutdown() {
            if (!confirm('🛑 This will shutdown the system. Are you sure?')) return;
            
            addToSessionLog('System', '🛑 Emergency shutdown initiated');
            
            try {
                const response = await fetch('/emergency/shutdown', {
                    method: 'POST'
                });
                
                alert('🛑 System shutdown initiated. Server will stop.');
            } catch (error) {
                alert(`❌ Shutdown failed: ${error.message}`);
            }
        }

        function clearChat() {
            if (confirm('Clear chat history?')) {
                document.getElementById('chat-messages').innerHTML = `
                    <div class="message agent">
                        <div class="header">
                            <span class="agent-name">🎯 Jasper</span>
                            <span class="role">Head Agent & Coordinator</span>
                            <span class="stability">🟢 Stable</span>
                        </div>
                        <div>Chat cleared! I'm ready to help you again.</div>
                    </div>
                `;
                addToSessionLog('System', 'Chat history cleared');
            }
        }

        // ENHANCED MESSAGE HANDLING
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add to session log
            addToSessionLog('User', message);
            
            // Call original function
            await originalSendMessage();
        };

        // Override original addAgentMessageToChat to include session logging
        const originalAddAgentMessage = addAgentMessageToChat;
        addAgentMessageToChat = function(agent) {
            addToSessionLog(agent.agent, agent.message);
            originalAddAgentMessage(agent);
        };

        // MODEL SWITCHER FUNCTIONS
        let currentProvider = 'ollama';
        
        async function switchModelProvider() {
            const providerSelect = document.getElementById('model-provider');
            const newProvider = providerSelect.value;
            
            if (newProvider === currentProvider) return;
            
            try {
                const response = await fetch('/switch_model_provider', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: newProvider })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentProvider = newProvider;
                    updateModelStatus(newProvider);
                    addToSessionLog('System', `Switched to ${newProvider} provider`);
                    
                    // Show success message
                    alert(`✅ Successfully switched to ${newProvider}!\n${result.message}`);
                } else {
                    // Revert selection on failure
                    providerSelect.value = currentProvider;
                    alert(`❌ Failed to switch providers: ${result.error}`);
                }
            } catch (error) {
                // Revert selection on error
                providerSelect.value = currentProvider;
                alert(`❌ Error switching providers: ${error.message}`);
            }
        }
        
        function updateModelStatus(provider) {
            const statusDiv = document.getElementById('model-status');
            const providerNames = {
                'ollama': 'Ollama',
                'openai_local': 'OpenAI Local'
            };
            
            const benefits = {
                'ollama': {
                    status: '🟢',
                    description: 'Stable & Reliable'
                },
                'openai_local': {
                    status: '🚀',
                    description: 'Faster & Smarter'
                }
            };
            
            const info = benefits[provider] || benefits.ollama;
            
            statusDiv.innerHTML = `
                <div class="status-row">
                    <span>Current: ${providerNames[provider]}</span>
                    <span class="status-indicator">${info.status}</span>
                </div>
                <div class="status-row">
                    <span>Cost: Free</span>
                    <span>Privacy: 🔒 Local</span>
                </div>
                <div class="status-row">
                    <span colspan="2">${info.description}</span>
                </div>
            `;
        }
        
        function showSetupGuide() {
            const guideWindow = window.open('', 'setupGuide', 'width=800,height=600,scrollbars=yes');
            guideWindow.document.write(`
                <html>
                <head>
                    <title>🚀 OpenAI Local Setup Guide</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        h1, h2 { color: #667eea; }
                        .safety { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0; }
                        .step { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea; }
                        code { background: #f1f1f1; padding: 2px 6px; border-radius: 4px; }
                        .warning { background: #fff3cd; padding: 10px; border-radius: 4px; border-left: 4px solid #ffc107; }
                    </style>
                </head>
                <body>
                    <h1>🚀 OpenAI Local Model Setup</h1>
                    
                    <div class="safety">
                        <h2>✅ SAFETY GUARANTEES</h2>
                        <ul>
                            <li><strong>100% Safe:</strong> Won't touch your existing Solvine setup</li>
                            <li><strong>100% Private:</strong> No data sent anywhere</li>
                            <li><strong>100% Free:</strong> Open-weight models cost nothing</li>
                            <li><strong>100% Reversible:</strong> Can switch back anytime</li>
                        </ul>
                    </div>
                    
                    <div class="step">
                        <h3>Step 1: Download Models (5-10 minutes)</h3>
                        <p>Create a models directory and download free models:</p>
                        <code>mkdir C:/AI/OpenAI-Local</code><br>
                        <code>git clone https://huggingface.co/microsoft/DialoGPT-medium C:/AI/OpenAI-Local/</code>
                    </div>
                    
                    <div class="step">
                        <h3>Step 2: Install Local Server (2 minutes)</h3>
                        <p>Install a local inference server:</p>
                        <code>pip install text-generation-webui</code><br>
                        <p><em>Or for lightweight option:</em></p>
                        <code>pip install llama-cpp-python</code>
                    </div>
                    
                    <div class="step">
                        <h3>Step 3: Start Local Server (30 seconds)</h3>
                        <p>Run the server:</p>
                        <code>python -m textgen --model C:/AI/OpenAI-Local/ --port 8080</code><br>
                        <p>Test in browser: <a href="http://localhost:8080">http://localhost:8080</a></p>
                    </div>
                    
                    <div class="step">
                        <h3>Step 4: Enable in Solvine (Instant)</h3>
                        <p>In the Model Switcher panel, select "OpenAI Local"</p>
                        <p>If any issues, just switch back to "Ollama"!</p>
                    </div>
                    
                    <div class="warning">
                        <strong>Pro Tip:</strong> Start with one agent to test, then switch others if you like the performance!
                    </div>
                    
                    <h2>📊 Expected Benefits</h2>
                    <ul>
                        <li>🚀 2-3x faster responses</li>
                        <li>🎯 Better logical reasoning</li>
                        <li>💡 More creative solutions</li>
                        <li>🔒 Still completely private</li>
                        <li>💰 Still completely free</li>
                    </ul>
                    
                    <p><strong>Questions?</strong> Just switch back to Ollama anytime. Your existing setup is never touched!</p>
                </body>
                </html>
            `);
        }
    </script>
</body>
</html>
